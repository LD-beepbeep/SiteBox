<!doctype html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a84ff"> 
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Site Box</title>
<style>
  :root{
    /* Light theme variables */
    --bg: #f3f6f8;
    --panel: #ffffff;
    --muted: #6f7c88;
    --text: #0b1220;
    --accent: #0a84ff;
    --accent-2: #0066cc;
    --danger: #ff3b30;
    --border: rgba(0,0,0,0.06);
    --shadow: 0 10px 30px rgba(10,14,20,0.06);
    --radius: 12px;
    --glass: rgba(255,255,255,0.6);
    font-family: -apple-system, "SF Pro Text", Roboto, "Segoe UI", Helvetica, Arial, sans-serif;
  }

  /* Dark theme overrides (flat, no gradients) */
  .dark {
    --bg: #07121a;
    --panel: #071b24;
    --muted: #9fb6c6;
    --text: #eaf6ff;
    --accent: #2f9bff;
    --accent-2: #1976d2;
    --danger: #ff6b65;
    --border: rgba(255,255,255,0.05);
    --shadow: 0 18px 40px rgba(0,0,0,0.6);
  }

  /* Respect prefers-reduced-motion */
  @media (prefers-reduced-motion: reduce) {
    :root { --reduce-motion: 1; }
  }
  :root { --reduce-motion: 0; }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin:0; min-height:100vh; display:flex; flex-direction:column;
    background-color: var(--bg);
    color: var(--text);
    -webkit-font-smoothing:antialiased;
    transition: background-color .28s ease, color .28s ease;
    font-synthesis:none;
  }

  /* header (flat, glass effect removed) */
  header{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    padding:12px 16px; position:sticky; top:0; z-index:40;
    background-color: transparent;
    border-bottom: 1px solid var(--border);
  }

  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:44px;height:44px;border-radius:10px;
    background-color: var(--accent);
    color:#fff; font-weight:800;
    display:flex;align-items:center;justify-content:center;
    box-shadow: var(--shadow);
    transition: transform .18s ease, box-shadow .18s ease;
  }
  .logo:active { transform: translateY(1px) scale(.995); }
  h1{margin:0;font-size:17px;font-weight:700}
  .controls{display:flex;gap:10px;align-items:center}

  .btn-icon{
    width:40px;height:40px;border-radius:10px;background:var(--panel);display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);cursor:pointer;
    box-shadow:0 6px 18px rgba(8,10,12,0.04);
    transition: transform .12s ease, box-shadow .12s ease, background-color .18s;
  }
  .btn-icon:active{transform:scale(.98)}
  .btn-icon:focus{outline:3px solid rgba(10,132,255,0.12);outline-offset:2px;border-radius:10px}

  /* Top controls */
  .topbar{display:flex;gap:12px;padding:10px 16px;align-items:center}
  .search{
    flex:1; display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:999px;
    background:var(--panel); border:1px solid var(--border); box-shadow:0 6px 16px rgba(10,14,20,0.03);
  }
  .search input{border:0;outline:0;background:transparent;font-size:15px;width:100%}
  .seg{display:flex;gap:6px;background:transparent;padding:4px;border-radius:999px}
  .seg button{border:0;background:transparent;padding:6px 10px;border-radius:999px;font-weight:700;color:var(--muted);cursor:pointer}
  .seg button.active{background-color:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(10,132,255,0.12)}

  /* Main content */
  main{flex:1;padding:12px 16px 110px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;color:var(--muted);font-size:13px}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px}
  .card{
    background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;
    border:1px solid var(--border);
    box-shadow: 0 8px 22px rgba(12,16,20,0.04);
    transform-origin:center;
    transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s ease, border-color .22s ease, background-color .28s ease;
    will-change: transform;
    opacity:0;
    animation: cardIn .42s cubic-bezier(.2,.9,.2,1) forwards;
    animation-delay: calc(var(--i,0) * 0.04s);
  }

  /* entrance animation */
  @keyframes cardIn {
    from { transform: translateY(10px) scale(.995); opacity:0; }
    to { transform: translateY(0) scale(1); opacity:1; }
  }

  /* prefer-reduced-motion: disable entrance */
  @media (prefers-reduced-motion: reduce) {
    .card { animation: none; opacity:1; transform:none; }
  }

  .card:hover{ transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 40px rgba(10,14,20,0.08); }
  .thumb{width:86px;height:86px;border-radius:16px;background-color:rgba(10,132,255,0.04);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .title{font-weight:700;font-size:13px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
  .badge{font-size:12px;color:var(--muted)}

  /* ACTIONS - buttons wrap and are tidy */
  .card .actions{
    width:100%;
    display:flex;
    gap:8px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
    margin-top:6px;
  }

  /* unified button styles (flat) */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    min-width:68px;
    padding:8px 12px;
    border-radius:10px;
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--text);
    transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease;
    box-shadow: 0 6px 16px rgba(8,10,12,0.04);
  }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 12px 28px rgba(8,10,12,0.06); }
  .btn:active{ transform: translateY(0); }

  .btn.primary{
    background: var(--accent);
    color: #fff;
    border-color: rgba(0,0,0,0.08);
    box-shadow: 0 12px 28px rgba(10,132,255,0.14);
  }
  .btn.secondary{
    background:var(--panel);
    color:var(--text);
  }
  .btn.danger{
    background:var(--danger);
    color:#fff;
    box-shadow: 0 10px 26px rgba(255,59,48,0.12);
  }

  .fav{cursor:pointer;font-size:18px;color:#cfcfcf;display:inline-flex;align-items:center;justify-content:center}
  .fav.active{color:#ffb703}

  .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .list-item{display:grid;grid-template-columns:64px 1fr 120px;align-items:center;gap:12px;padding:10px;border-radius:12px;background:var(--panel);border:1px solid var(--border)}

  .sheet{
    position:fixed;left:12px;right:12px;bottom:18px;background:var(--panel);border-radius:12px;padding:14px;border:1px solid var(--border);z-index:90;
    transform: translateY(12px) scale(.995); opacity:0; pointer-events:none;
    transition: transform .26s cubic-bezier(.2,.9,.2,1), opacity .26s ease;
  }
  .sheet.open{ transform: translateY(0) scale(1); opacity:1; pointer-events:auto; }

  .field{display:flex;flex-direction:column;margin-bottom:10px}
  .field input[type=text], .field textarea, .field select{padding:10px;border-radius:8px;border:1px solid var(--border);font-size:14px;background:transparent;color:var(--text)}
  .actions-sheet{display:flex;justify-content:flex-end;gap:8px}
  .btn.ghost{background:transparent;color:var(--muted);box-shadow:none}

  /* overlay for embed (fade in) */
  #overlay{position:fixed;inset:0;background:rgba(8,10,12,0.5);display:none;align-items:center;justify-content:center;z-index:100;opacity:0;transition:opacity .2s ease}
  #overlay.show{ display:flex; opacity:1; }
  .frame{width:96%;max-width:1100px;height:86%;border-radius:12px;background:var(--panel);overflow:hidden;border:1px solid var(--border)}
  .frame iframe{width:100%;height:100%;border:0;background:transparent}

  @media(max-width:600px){
    .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
    header{padding:10px}
    main{padding-bottom:140px}
    .btn{min-width:56px;padding:7px 10px;font-size:13px}
  }

</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo" aria-hidden>SB</div>
    <div>
      <h1>Site Box</h1>
      <div style="color:var(--muted);font-size:13px"></div>
    </div>
  </div>

  <div class="controls" role="group" aria-label="Header controls">
    <button id="addBtn" class="btn-icon" title="Add app">➕</button>
    <button id="exportBtn" class="btn-icon" title="View Source">👀</button>
    <button id="darkBtn" class="btn-icon" title="Toggle dark">🌓</button>
  </div>
</header>

<div class="topbar">
  <div class="search" role="search">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <input id="search" placeholder="Search apps or URLs" aria-label="Search apps" />
  </div>

  <div class="seg" role="tablist" aria-label="Sort">
    <button data-sort="recent" class="active">Recent</button>
    <button data-sort="alpha">A→Z</button>
    <button data-sort="fav">★</button>
  </div>
</div>

<main>
  <div class="meta">
    <div id="count" style="color:var(--muted);font-size:13px">0 apps</div>
    <div></div>
  </div>

  <section id="grid" class="grid" role="list" aria-live="polite"></section>
  <section id="list" class="list" style="display:none" aria-live="polite"></section>
</main>

<!-- Add / Edit Sheet -->
<aside id="sheet" class="sheet" role="dialog" aria-modal="true" aria-hidden="true">
  <h3 id="sheetTitle">Add App</h3>

  <div class="field">
    <label>Type</label>
    <select id="type">
      <option value="embed">Embed HTML (static)</option>
      <option value="url">URL (open externally)</option>
    </select>
  </div>

  <div class="field">
    <label>Title</label>
    <input id="title" type="text" placeholder="App title (e.g., My Demo)" />
  </div>

  <div id="embedBox">
    <div class="field">
      <label>Paste HTML</label>
      <textarea id="html" rows="6" placeholder="Full HTML for static demos"></textarea>
    </div>
    <div class="field">
      <label>Or upload HTML file</label>
      <input id="htmlFile" type="file" accept=".html,text/html" />
    </div>
  </div>

  <div id="urlBox" style="display:none">
    <div class="field">
      <label>URL</label>
      <input id="url" type="text" placeholder="https://example.com" />
      <div style="color:var(--muted);font-size:13px">Links open in a new tab (use for dynamic/live sites).</div>
    </div>
  </div>

  <div class="field">
    <label>Icon (optional)</label>
    <input id="icon" type="file" accept="image/*" />
  </div>

  <div class="field">
    <label>Category (optional)</label>
    <input id="category" type="text" placeholder="e.g., Games, Demos, Tools" />
  </div>

  <div class="actions-sheet">
    <button id="cancel" class="btn ghost">Cancel</button>
    <button id="save" class="btn">Save</button>
  </div>
</aside>

<!-- Overlay for embed -->
<div id="overlay" aria-hidden="true">
  <div class="frame" role="document">
    <iframe id="frame" sandbox="allow-scripts allow-forms" title="Embedded app"></iframe>
  </div>
</div>

<script>
(() => {
  'use strict';

  // -- Storage keys
  const KEY = 'sitebox_apps_v1';
  let apps = JSON.parse(localStorage.getItem(KEY) || '[]'); // {id,title,type,html,url,icon,category,created,fav}

  // -- DOM refs
  const el = id => document.getElementById(id);
  const grid = el('grid'), list = el('list'), count = el('count');
  const addBtn = el('addBtn'), exportBtn = el('exportBtn'), darkBtn = el('darkBtn');
  const sheet = el('sheet'), sheetTitle = el('sheetTitle'), typeSel = el('type'), titleIn = el('title');
  const htmlIn = el('html'), htmlFile = el('htmlFile'), urlIn = el('url'), iconIn = el('icon'), categoryIn = el('category');
  const embedBox = el('embedBox'), urlBox = el('urlBox'), cancelBtn = el('cancel'), saveBtn = el('save');
  const overlay = el('overlay'), frame = el('frame'), search = el('search');
  const sortBtns = document.querySelectorAll('[data-sort]');

  // -- utility
  const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  const save = ()=> { localStorage.setItem(KEY, JSON.stringify(apps)); render(); };
  const readDataURL = file => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const escape = s => (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // -- render
  function render(){
    const q = (search.value||'').trim().toLowerCase();
    let listData = apps.slice();

    // search filter
    if(q) listData = listData.filter(a =>
      (a.title||'').toLowerCase().includes(q) ||
      (a.category||'').toLowerCase().includes(q) ||
      (a.url||'').toLowerCase().includes(q)
    );

    // sort
    const activeSort = document.querySelector('[data-sort].active')?.dataset.sort || 'recent';
    if(activeSort === 'recent') listData.sort((a,b)=> b.created - a.created);
    if(activeSort === 'alpha') listData.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
    if(activeSort === 'fav') listData.sort((a,b)=> (b.fav?1:0) - (a.fav?1:0));

    // counts
    count.textContent = `${apps.length} app${apps.length===1?'':'s'}`;

    // grid
    grid.innerHTML = '';
    if(listData.length === 0){
      grid.innerHTML = '<p style="color:var(--muted)">No apps yet. Tap + to add one.</p>';
    } else {
      listData.forEach((a, i) => {
        const node = card(a);
        // set custom property for stagger timing
        node.style.setProperty('--i', String(i));
        grid.appendChild(node);
      });
    }

    // list view
    list.innerHTML = '';
    listData.forEach(a => list.appendChild(listItem(a)));
  }

  // -- card
  function card(a){
    const elCard = document.createElement('div'); elCard.className = 'card'; elCard.tabIndex = 0;
    const thumb = document.createElement('div'); thumb.className = 'thumb';
    if(a.icon) thumb.innerHTML = `<img src="${a.icon}" alt="${escape(a.title)}">`;
    else thumb.innerHTML = (a.type==='url') ? '<div style="font-size:28px">🌐</div>' : '<div style="font-size:28px">📄</div>';
    const title = document.createElement('div'); title.className='title'; title.textContent = a.title || a.url || 'Untitled';
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='10px'; row.style.width='100%'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    const cat = document.createElement('div'); cat.className='badge'; cat.textContent = a.category || '';
    const fav = document.createElement('div'); fav.className='fav' + (a.fav ? ' active' : ''); fav.innerHTML = '★'; fav.title = a.fav ? 'Unfavorite' : 'Favorite';
    fav.addEventListener('click', e => { e.stopPropagation(); a.fav = !a.fav; save(); });
    row.appendChild(cat); row.appendChild(fav);

    const actions = document.createElement('div'); actions.className = 'actions';
    const openBtn = document.createElement('button'); openBtn.className='btn primary'; openBtn.innerHTML = (a.type==='url' ? 'Open' : 'Preview');
    openBtn.addEventListener('click', e => { e.stopPropagation(); openApp(a); });

    const editBtn = document.createElement('button'); editBtn.className='btn secondary'; editBtn.textContent='Edit';
    editBtn.addEventListener('click', e => { e.stopPropagation(); editApp(a.id); });

    const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', e => { e.stopPropagation(); if(confirm('Delete this app?')) { apps = apps.filter(x => x.id !== a.id); save(); }});

    actions.appendChild(openBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

    elCard.appendChild(thumb); elCard.appendChild(title); elCard.appendChild(row); elCard.appendChild(actions);

    elCard.addEventListener('dblclick', ()=> openApp(a));
    elCard.addEventListener('keydown', e => { if(e.key==='Enter') openApp(a); });

    return elCard;
  }

  function listItem(a){
    const row = document.createElement('div'); row.className='list-item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.style.width='56px'; thumb.style.height='56px';
    thumb.innerHTML = a.icon ? `<img src="${a.icon}" alt="${escape(a.title)}">` : (a.type==='url' ? '<div style="font-size:20px">🌐</div>' : '<div style="font-size:20px">📄</div>');
    const mid = document.createElement('div'); mid.style.display='flex'; mid.style.flexDirection='column';
    const t = document.createElement('div'); t.textContent = a.title || a.url || 'Untitled'; t.style.fontWeight='700';
    const sub = document.createElement('div'); sub.style.color='var(--muted)'; sub.textContent = a.category || '';
    mid.appendChild(t); mid.appendChild(sub);
    const info = document.createElement('div'); info.style.color='var(--muted)'; info.textContent = a.type === 'url' ? 'Link' : 'Embed';
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    const openBtn = document.createElement('button'); openBtn.className='btn primary'; openBtn.textContent='Open'; openBtn.addEventListener('click', ()=> openApp(a));
    const editBtn = document.createElement('button'); editBtn.className='btn secondary'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=> editApp(a.id));
    actions.appendChild(openBtn); actions.appendChild(editBtn);
    row.appendChild(thumb); row.appendChild(mid); row.appendChild(info); row.appendChild(actions);
    return row;
  }

  // -- open app
  function openApp(a){
    if(a.type === 'url'){ window.open(a.url, '_blank', 'noopener'); return; }
    const blob = new Blob([a.html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    frame.src = url;
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  overlay.addEventListener('click', e => { if(e.target === overlay) closeOverlay(); });
  document.addEventListener('keydown', e => { if(e.key === 'Escape' && overlay.classList.contains('show')) closeOverlay(); });
  function closeOverlay(){ frame.src = 'about:blank'; overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

  // -- add/edit
  let editingId = null;
  addBtn.addEventListener('click', ()=> openSheet());
  function openSheet(data = null){
    editingId = null;
    sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
    sheetTitle.textContent = 'Add App';
    typeSel.value = 'embed';
    titleIn.value = '';
    htmlIn.value = '';
    urlIn.value = '';
    categoryIn.value = '';
    iconIn.value = '';
    embedBox.style.display = '';
    urlBox.style.display = 'none';
    if(data){
      editingId = data.id;
      sheetTitle.textContent = 'Edit App';
      typeSel.value = data.type;
      titleIn.value = data.title || '';
      categoryIn.value = data.category || '';
      if(data.type === 'url'){ urlIn.value = data.url || ''; embedBox.style.display='none'; urlBox.style.display=''; }
      else { htmlIn.value = data.html || ''; embedBox.style.display=''; urlBox.style.display='none'; }
    }
    setTimeout(()=> titleIn.focus(), 120);
  }
  function editApp(id){
    const a = apps.find(x=>x.id===id); if(!a) return;
    openSheet(a);
  }
  cancelBtn.addEventListener('click', ()=> { sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); editingId = null; });

  typeSel.addEventListener('change', ()=> {
    if(typeSel.value === 'url'){ embedBox.style.display='none'; urlBox.style.display=''; }
    else { embedBox.style.display=''; urlBox.style.display='none'; }
  });

  htmlFile.addEventListener('change', async e => {
    const f = e.target.files[0];
    if(!f) return;
    if(!f.type.includes('html') && !f.name.endsWith('.html')) return alert('Select an HTML file');
    htmlIn.value = await f.text();
  });

  saveBtn.addEventListener('click', async ()=> {
    const type = typeSel.value;
    const title = titleIn.value.trim();
    const category = categoryIn.value.trim();
    let iconData = '';
    if(iconIn.files[0]) iconData = await readDataURL(iconIn.files[0]);

    if(editingId){
      const app = apps.find(a=>a.id===editingId);
      if(!app) return;
      app.title = title || app.title;
      app.category = category;
      if(iconData) app.icon = iconData;
      if(type === 'url'){
        const url = (urlIn.value||'').trim();
        try { new URL(url); } catch { return alert('Invalid URL'); }
        app.type = 'url'; app.url = url; app.html = '';
      } else {
        const html = htmlIn.value || '';
        if(!html) return alert('Please provide HTML');
        app.type = 'embed'; app.html = html; app.url = '';
      }
      app.modified = Date.now();
    } else {
      const id = uid();
      if(type === 'url'){
        const url = (urlIn.value||'').trim();
        try { new URL(url); } catch { return alert('Invalid URL'); }
        apps.push({id, title: title || url, type:'url', url, icon: iconData, category, created: Date.now(), fav:false});
      } else {
        const html = htmlIn.value || '';
        if(!html) return alert('Please paste or upload HTML');
        apps.push({id, title: title || 'Untitled', type:'embed', html, icon: iconData, category, created: Date.now(), fav:false});
      }
    }
    save();
    sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); editingId = null;
  });

  // -- search & sort
  search.addEventListener('input', ()=> render());
  sortBtns.forEach(b => b.addEventListener('click', ()=>{
    sortBtns.forEach(x => x.classList.remove('active'));
    b.classList.add('active'); render();
  }));

  // -- exportBtn now only opens the site
  exportBtn.addEventListener('click', ()=> {
    window.open("https://www.view-page-source.com/", "_blank");
  });

  // -- drag & drop quick add (HTML file)
  document.addEventListener('dragover', e => { e.preventDefault(); });
  document.addEventListener('drop', async e => {
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if(!f) return;
    if(f.type.includes('html') || f.name.endsWith('.html')){
      const html = await f.text();
      openSheet({ type:'embed', title: f.name.replace(/\.html?$/i,''), html });
    } else {
      alert('Drop an HTML file to add it as a static app, or use Add to save a link.');
    }
  });

  // -- dark toggle (toggles .dark on <html>)
  darkBtn.addEventListener('click', ()=> {
    document.documentElement.classList.toggle('dark');
  });

  // -- initial (start empty)
  if(!apps || apps.length === 0){
    apps = []; save();
  }

  window.SiteBox = { apps, save, render };

  render();
})();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker registered'))
      .catch(err => console.error('SW registration failed:', err));
  }
</script>
</body>
</html>
